# Database Migrations

This directory contains the consolidated database schema for the Sonar Platform on Neon.

## Migration Files

### 001_initial_schema.sql
This is the complete database schema as it exists in the production Neon database. It was generated by:
1. Analyzing all SQL scripts in the `/scripts` directory
2. Checking the actual database structure in Neon 
3. Consolidating only the current, relevant schema elements

## Key Differences from Original Scripts

### Removed/Modified Elements:
- **Removed `is_verified` field** from `tracked_wallets` (was in fix-missing-wallet-fields.sql but not in production)
- **Removed `price_usd` field** from `whale_trades` (was in fix-missing-wallet-fields.sql but not in production)
- **Modified webhook functions** - They exist but don't send HTTP requests on Neon (no http extension)
- **Added IDENTITY generation** for `whale_trades.id` to match production

### Supabase-Specific Elements Removed:
- HTTP extension and http_post functionality
- Supabase realtime publication commands
- Row Level Security (RLS) policies

### Current Database Structure:
- **Extensions**: uuid-ossp, pgcrypto
- **Tables**: tracked_wallets, tokens, whale_trades, trade_signals, portfolio_trades, signal_config, service_configs, service_heartbeats
- **Views**: active_signals_detailed, dashboard_stats, recent_whale_trades
- **Functions**: check_for_signals, update_service_config_timestamp, notify_signal_webhook, notify_trade_webhook, test_webhook
- **Triggers**: trigger_check_signals, update_service_configs_timestamp, webhook triggers (placeholder)

## Running Migrations

To apply this schema to a fresh Neon database:

```bash
# Using psql
psql -h <host> -U <user> -d <database> -f migrations/001_initial_schema.sql

# Or using the Neon CLI/dashboard SQL editor
```

## Notes

The webhook functions (`notify_signal_webhook`, `notify_trade_webhook`) exist in the schema for compatibility but don't actually send HTTP requests on Neon. The application should handle webhook notifications through the application layer instead of database triggers.