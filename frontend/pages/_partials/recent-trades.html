<div id="trades-feed">
    <!-- Trades will be loaded from database -->
</div>

<script>
// Load real trades from database
async function loadRecentTrades() {
    try {
        const response = await fetch('/api/trades');
        const trades = await response.json();
        
        const feed = document.getElementById('trades-feed');
        
        if (trades.length === 0) {
            feed.innerHTML = '<p style="color: var(--pico-muted-color); text-align: center; padding: 2rem;">No recent trades found</p>';
            return;
        }
        
        const tradesHtml = trades.map(trade => {
            const tokenSymbol = trade.tokens?.symbol || 'Unknown';
            const walletAlias = trade.tracked_wallets?.alias || `${trade.wallet_address.slice(0, 8)}...${trade.wallet_address.slice(-4)}`;
            const walletColor = trade.tracked_wallets?.ui_color || '#4338ca';
            const timeAgo = getTimeAgo(trade.trade_timestamp);
            const solAmount = trade.sol_amount ? trade.sol_amount.toFixed(2) : '0.00';
            
            return `
                <article class="feed-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong class="trade-type ${trade.trade_type.toLowerCase()}">${trade.trade_type}</strong>
                            <span style="margin-left: 0.5rem;">${solAmount} SOL</span>
                        </div>
                        <small style="color: var(--pico-muted-color);">${timeAgo}</small>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span class="wallet-color" style="background-color: ${walletColor};"></span>
                        <small>${walletAlias}</small>
                    </div>
                    <div style="margin-top: 0.25rem;">
                        <code style="font-size: 0.75rem;">Token: ${tokenSymbol}</code>
                    </div>
                </article>
            `;
        }).join('');
        
        feed.innerHTML = tradesHtml;
    } catch (error) {
        console.error('Error loading trades:', error);
        document.getElementById('trades-feed').innerHTML = '<p style="color: var(--pico-color-red-500);">Error loading trades</p>';
    }
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const tradeTime = new Date(timestamp);
    const diffMs = now - tradeTime;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffDays > 0) return `${diffDays}d ago`;
    if (diffHours > 0) return `${diffHours}h ago`;
    if (diffMins > 0) return `${diffMins}m ago`;
    return 'just now';
}

// Load trades on page load
loadRecentTrades();

// Listen for real-time updates via SSE
document.addEventListener('htmx:sseMessage', (event) => {
    if (event.detail.data.type === 'new_trade') {
        // Add new trade to feed
        const trade = event.detail.data.trade;
        const newTrade = document.createElement('article');
        newTrade.className = 'feed-item';
        newTrade.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong class="trade-type ${trade.trade_type.toLowerCase()}">${trade.trade_type}</strong>
                    <span style="margin-left: 0.5rem;">${trade.sol_amount} SOL</span>
                </div>
                <small style="color: var(--pico-muted-color);">just now</small>
            </div>
            <div style="margin-top: 0.5rem;">
                <span class="wallet-color" style="background-color: ${trade.wallet_color || '#4338ca'};"></span>
                <small>${trade.wallet_alias || trade.wallet_address}</small>
            </div>
            <div style="margin-top: 0.25rem;">
                <code style="font-size: 0.75rem;">Token: ${trade.token_symbol || trade.coin_address}</code>
            </div>
        `;
        
        const feed = document.getElementById('trades-feed');
        feed.insertBefore(newTrade, feed.firstChild);
        
        // Keep only last 10 trades
        while (feed.children.length > 10) {
            feed.removeChild(feed.lastChild);
        }
    }
});
</script>